<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <meta name="viewport" content="maximum-scale=1.0,
    minimum-scale=1.0,
    user-scalable=0,
    width=device-width,
    initial-scale=1.0"/>
    <title>乐火售货机</title>
    <link rel="stylesheet" href="../../static/css/public.css"/>
</head>
<body>
<div class="title" id="title"></div>
<div id="goodsView" class="goods-view"></div>
<script type="text/x-dot-template" id="goodListTemplate">
    <div><img src="htt"/></div>
    {{if(it.length>0){}}
    <ul class="goods-list">
        {{for(var i = 0;i<it.length;i++){}}
        <li class="goods-info">
            <div class="select-many">
                {{if(it[i].available && (it[i].machineState==1 || it[i].machineState==2)){}}
                <div data-id="{{=it[i].id}}" class="unsel" onclick="selectThisGoods(this)"></div>
                {{}else{}}
                <div data-id="{{=it[i].id}}" class="unsel" onclick = "alert('机器断电，或者无商品')"></div>
                {{}}}
            </div>
            {{if(it[i].available && (it[i].machineState==1 || it[i].machineState==2)){}}
            <div class="select-content" onclick=checkThisGoods('{{=it[i].id}}','{{=it[i].price}}','{{=it[i].commodityName}}','{{=it[i].shrinkageChart}}')>
                {{}else{}}
                <div class="select-content" onclick = "alert('机器断电，或者无商品')">
                    {{}}}
                    <!--<div class="passageway"></div>-->
                    <div class="goods-content">
                        <div class="goods-img" style="background: url(../{{=it[i].shrinkageChart}}) no-repeat;background-size: 100% 100%;"></div>
                        <div class="goods-details">
                            <div class="goods-name" style="margin-top:10px;">{{=it[i].commodityName}}</div>

                            <div class="goods-num">￥{{=it[i].price}}</div>
                            <div class="goods-mg"><img src="../../static/img/warehouseDoor.png"></img>仓门：{{=it[i].num}}门</div>


                            <div class="is-use">
                                {{if(it[i].available && (it[i].machineState==1 || it[i].machineState==2)){}}
                                <div>商品可用</div>
                                {{}else{}}
                                <div>商品不可用</div>
                                {{}}}
                            </div>
                        </div>
                    </div>
                    <!--<div class="goods-handle">-->

                        <!--<div class="goods-check">{{=it[i].available?'点击查看':''}}</div>-->
                    <!--</div>-->
                </div>
        </li>
        {{}}}
    </ul>
    {{}else{}}
    <div style="text-align: center;color: #666;font-size: 16px">暂无商品</div>
    {{}}}
</script>

<div class="payment-many">
    <div class="price">合计：<span id="manyNum">0</span></div>
    <div class="goods-btn"  onclick="purchase()">去结算</div>
</div>
<script type="text/javascript" src="../../static/js/jquery.min.js"></script>
<script type="text/javascript" src="../../static/js/dot.min.js"></script>
<script type="text/javascript">
    //获取商品列表
    $.ajax({
        url: 'http://vendor.xinxiconnect.com/api/machinePosition/queryByMachineCode/'+getQueryStringByName("code"),
        type: "get",
        data: {},
        success: function (data) {
            $("#title").html(data.result[0].machineName);
            // debugger
            tmpltxt=doT.template(document.getElementById("goodListTemplate").innerHTML);//生成模板方法
            document.getElementById("goodsView").innerHTML=tmpltxt(data.result);//数据渲染

        }
    })
    localStorage.setItem("code",getQueryStringByName("code"));//缓存code到localStorage
    /**
     * 多个商品购买
     * */
    function purchase() {
        var goodsIdStr = "";
        $(".sel").each(function(index,item){
            if(index != 0) goodsIdStr += ",";
            goodsIdStr += $(item).attr("data-id");
            debugger
        })
        $.ajax({
            url: '/api/order/saveOrder/'+goodsIdStr,
            type: "get",
            data: {},
            success: function (data) {
                location.href="./orderInfo.html?unifiedNum="
                    +data.result.unifiedNum+"&price="+data.result.price
                    +"&machineName="+data.result.machineName+"&positionNum="+data.result.positionNum
                    +"&commodityName="+data.result.commodityName+"&createTime="+timeStamp2String(new Date())+"&des="+data.result.commodityDes
                    +"&shrinkageChart="+"static/img/order.jpg"
                ;
            }
        })
    };
    function timeStamp2String(time){
        var datetime = new Date();
        datetime.setTime(time);
        var year = datetime.getFullYear();
        var month = datetime.getMonth() + 1 < 10 ? "0" + (datetime.getMonth() + 1) : datetime.getMonth() + 1;
        var date = datetime.getDate() < 10 ? "0" + datetime.getDate() : datetime.getDate();
        var hour = datetime.getHours()< 10 ? "0" + datetime.getHours() : datetime.getHours();
        var minute = datetime.getMinutes()< 10 ? "0" + datetime.getMinutes() : datetime.getMinutes();
        var second = datetime.getSeconds()< 10 ? "0" + datetime.getSeconds() : datetime.getSeconds();
        return year + "-" + month + "-" + date+" "+hour+":"+minute+":"+second;
    }

    /**
     * 打开商品详情
     * @param machinePositionId 仓位Id
     */
    function checkThisGoods(machinePositionId,price,commodityName,shrinkageChart){
        // var name = encodeURI(encodeURI(commodityName))
        location.href="./goodsDetails.html?machinePositionId="+machinePositionId+"&price="+price+"&commodityName="+commodityName+"&shrinkageChart="+shrinkageChart;
    }
    /**
     * 选择/取消商品并计数
     * @param element 选择去取消按钮
     */
    function selectThisGoods(element){
        $(element).toggleClass("unsel").toggleClass("sel");
        $("#manyNum").text($(".sel").length);
    }
    /*
     * 截取地址栏参数值并返回
     */
    function getQueryStringByName(name) {
        var result = location.search.match(new RegExp("[\?\&]" + name + "=([^\&]+)", "i"));
        if (result == null || result.length < 1) {
            return "";
        }
        return result[1];
    }
</script>
</body>
</html>